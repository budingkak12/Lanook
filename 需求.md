
下面是整理后的《本机备份功能需求（安卓端 + 后端落地说明）》完整版，已补充“上传即落地到电脑实际硬盘目录并触发扫描/处
  理”的要点，并对齐现有《资产处理与“扫描”设计记录（2025-11）》的语义。

  1 入口与总体

- 设置页新增“本机备份”卡片：展示开/关、待上传数、失败数、上次成功时间；点击进入“备份路径管理”。
- 备份可前台/后台运行，遵守网络、电量策略，不影响现有浏览。
  
  2 文件权限按钮
  
- 卡片顶部按钮：未授权态“申请文件权限”（灰色）；授权后显示绿色对勾“已获得访问本机文件权限”，按钮变为禁用或“重新授权”。
- 点击触发 SAF ACTION_OPEN_DOCUMENT_TREE，takePersistableUriPermission 持久化读权限；必要时兼容 READ_MEDIA_IMAGES/
VIDEO。
- 权限丢失自动回退未授权态；未授权时禁用“添加目录”/扫描/上传，并给出提示。
  
  3 路径管理
  
- 列表展示目录：名称、启用/暂停、未备份数、上次扫描时间、模式（仅图片/含视频）。
- 操作：启用/暂停、重新扫描、删除、重命名别名、切换“仅图片/含视频”。
- 添加：按钮→SAF 选目录→校验可读→持久化权限→写入表并立即全量扫描。
- 删除：确认后移除记录，取消相关未完成任务，释放权限；已上传文件不删除。
- 冲突：同一路径禁止重复；父子目录冲突需提示用户选择保留父或子，可选“忽略子目录”。
  
  4 备份策略
  
- 网络：仅 Wi‑Fi。
- 电量：不限（可后续扩展低电量暂停）。
- 媒体范围：图片/视频开关。
- 质量：原图。
- 并发与分块：并发 1–3，分块 2–8MB，自动按网络调节。
- 调度：手动“立即扫描”“立即上传”（周期扫描后续可选）。
  
  5 扫描与任务生成（本地侧）
  
- 使用 DocumentFile 递归启用目录；读 size、mtime、可选 hash；过滤隐藏/临时文件。
- 去重：size+mtime 或 hash 命中则标记“已备份”不入队。
- 任务表：记录文件 URI、size、mtime、hash、状态（pending/uploading/success/failed/cancelled）、已上传字节、错误、重试
计数。
  
  6 上传落地与服务器侧衔接
  
- API 约定：initUpload(hash, size, name, mime, relativePath) → upload_id/已存在；uploadChunk(upload_id, idx, body)；
finishUpload(upload_id).
- 上传完成后，服务端将文件直接写入电脑本地硬盘的入站目录（建议 incoming/mobile/{device}/...，可配置）。
- finish 成功后，服务器触发“扫描”流水线：导入 Media → 资产处理（缩略图/元数据）→ AI 标签/向量/NSFW/人脸聚类；与《资产处
理与扫描设计记录.md》保持一致（即视所有活动媒体路径为一个总仓库处理）。
- 秒传：init 返回“已存在”则直接 success，不上传数据。
- 重试：超时/5xx 指数退避；支持手动单项重试。
- 断点续传：查询已上传块，续传剩余块。
  
  7 运行与暂停
  
- 全局暂停：停止新任务生成与上传；进行中按设计立即停或完成当前块后停。
- 条件未满足（Wi‑Fi/充电等拓展）时任务排队，满足后自动恢复。
- 前台通知：展示当前文件、速度、剩余，可暂停/停止。
  
  8 错误与状态反馈
  
- 失败列表：文件名、错误原因、重试按钮。
- 权限不足/服务器不可达/磁盘不足分别提示；设置卡片计数同步。
- 上次成功时间、已上传/剩余数量实时刷新；UI 与通知一致。
  
  9 模块拆分（避免巨无霸）
  
- Room：BackupFolder、BackupTask、DAO、DB。
- 仓库：BackupRepository（扫描/任务生成）、UploadRepository（分块上传）。
- Worker：BackupWorker（扫描+上传）、RetryWorker（失败重试）。
- UI：BackupSettingsScreen（卡片+权限按钮）、BackupPathScreen（列表/操作）、BackupStatsCard、BackupPermissionBanner。
- 网络：独立 UploadApi（Retrofit），不膨胀现有 ApiService.kt。
  
  10 验收要点 / 测试关注
  
- 权限按钮状态准确；未授权无法添加路径。
- 新增/删除/暂停路径行为与任务状态一致，冲突检测有效。
- 扫描后待上传数正确；秒传不耗流量。
- 断点续传成功；Wi‑Fi 等条件限制下正确排队恢复。
- UI 与通知的进度、失败计数一致；服务器不可达时按退避重试。