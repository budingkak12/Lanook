# ===================================================================
# 前端伪代码（更新版）
# - 注意：sessionSeed 是“随机种子”，与用户/登录无关
# - 仅标签列表（like / favorite）使用“网格缩略图”展示；点击缩略图进入详情（播放器）
# - 推荐流（feed）直接用于播放器，不展示缩略图列表
# - 规则：播放器用原资源（resourceUrl）；列表用缩略图（thumbnailUrl）
# - 播放器采用“上下方向滑动”切换：上滑下一条、下滑上一条
# ===================================================================

# 本次运行的随机种子（由后端生成或前端请求生成）
sessionSeed = null

# 工作区集合，为每个上下文（如首页、标签页）保存独立状态
workspaces = {}

# 当前激活的工作区ID
activeWorkspace = null

# 当前UI视图：'player'（播放器）或 'tag_grid'（标签网格缩略图列表）
currentView = 'player'

# WorkspaceState Object:
# {
#   mediaList: [MediaItem],
#   currentIndex: number,
#   offset: number,
#   hasMore: boolean,
#   isLoading: boolean
# }

# MediaItem Object（标签列表需包含缩略图字段）:
# {
#   id: number,
#   url: string,            # 兼容字段（与 resourceUrl 等价）
#   resourceUrl: string,    # 原媒体资源 URL（播放器使用）
#   type: 'image' | 'video',
#   filename: string,
#   createdAt: string,
#   thumbnailUrl?: string,  # 仅标签列表使用（网格缩略图渲染）
#   playbackPosition: number // 前端状态
# }

function switchToWorkspace(workspaceId, options = {}):
    if workspaces[workspaceId] == null:
        workspaces[workspaceId] = { mediaList: [], currentIndex: 0, offset: 0, hasMore: true, isLoading: false }
        loadMoreMediaFor(workspaceId)

    if options.startIndex != null:
        workspaces[workspaceId].currentIndex = options.startIndex

    activeWorkspace = workspaceId

    # 切换视图：feed -> 播放器；tag_* -> 网格缩略图
    if workspaceId == 'feed':
        currentView = 'player'
    else if workspaceId.startsWith('tag_'):
        currentView = 'tag_grid'

function loadMoreMediaFor(workspaceId):
    ws = workspaces[workspaceId]
    if ws.isLoading or not ws.hasMore: return
    ws.isLoading = true

    api_path = null
    if workspaceId == 'feed':
        # 首页播放器数据源：原资源信息列表
        api_path = `/media-resource-list?seed=${sessionSeed}&offset=${ws.offset}&limit=PAGE_SIZE&order=seeded`
    else if workspaceId.startsWith('tag_'):
        tag = workspaceId.split('_')[1]
        # 标签页缩略图数据源：唯一列表端点
        api_path = `/thumbnail-list?tag=${tag}&offset=${ws.offset}&limit=PAGE_SIZE`

    newMediaItems = GET api_path

    for item in newMediaItems:
        item.playbackPosition = 0

    ws.mediaList.extend(newMediaItems)
    ws.offset += newMediaItems.length
    ws.hasMore = newMediaItems.length > 0
    ws.isLoading = false

# 应用冷启动：获取随机种子并进入推荐流
function onAppColdStart():
    resp = POST /session { optional_seed }
    sessionSeed = resp.session_seed
    switchToWorkspace('feed')

# 播放器交互（上下滑切换）
function onSwipeUp():
    ws = workspaces[activeWorkspace]
    if ws == null: return
    newIndex = ws.currentIndex + 1
    if newIndex >= ws.mediaList.length - 3 and ws.hasMore:
        loadMoreMediaFor(activeWorkspace)
    if newIndex < ws.mediaList.length:
        ws.currentIndex = newIndex

function onSwipeDown():
    ws = workspaces[activeWorkspace]
    if ws == null: return
    newIndex = ws.currentIndex - 1
    if newIndex >= 0:
        ws.currentIndex = newIndex

# 标签操作（全局标签，无用户）
function onClickLike():
    ws = workspaces[activeWorkspace]
    currentMedia = ws.mediaList[ws.currentIndex]
    POST /tag { media_id: currentMedia.id, tag: "like" }

function onClickFavorite():
    ws = workspaces[activeWorkspace]
    currentMedia = ws.mediaList[ws.currentIndex]
    POST /tag { media_id: currentMedia.id, tag: "favorite" }

function onClickRemoveLike():
    ws = workspaces[activeWorkspace]
    currentMedia = ws.mediaList[ws.currentIndex]
    DELETE /tag { media_id: currentMedia.id, tag: "like" }

function onClickRemoveFavorite():
    ws = workspaces[activeWorkspace]
    currentMedia = ws.mediaList[ws.currentIndex]
    DELETE /tag { media_id: currentMedia.id, tag: "favorite" }

# 视图导航
function navigateToHomeTab():
    switchToWorkspace('feed')

function openTagGrid(tag, scrollToIndex = null): # tag 为 'favorite' 或 'like'
    switchToWorkspace(`tag_${tag}`)
    # UI 渲染为“网格缩略图”，数据来源 GET /thumbnail-list?tag=<tag>
    if scrollToIndex != null:
        # 将网格滚动定位到指定索引（保持浏览位置）
        # grid.scrollToIndex(scrollToIndex)

function onThumbnailClick(tag, index):
    # 在当前标签工作区中，点击缩略图进入详情（播放器视图），并在该列表顺序中播放
    workspaceId = `tag_${tag}`
    switchToWorkspace(workspaceId, { startIndex: index })
    currentView = 'player'

function onBackFromTagDetail(tag):
    # 从播放器返回标签列表页时，定位到当前播放索引
    workspaceId = `tag_${tag}`
    ws = workspaces[workspaceId]
    if ws != null:
        openTagGrid(tag, ws.currentIndex)

# 手势与输入映射（伪代码）
SWIPE_THRESHOLD = 30 # 像素阈值，按需调整

function onTouchEnd(deltaY):
    # deltaY < 0 表示向上滑动（下一条）；deltaY > 0 表示向下滑动（上一条）
    if deltaY < -SWIPE_THRESHOLD:
        onSwipeUp()
    else if deltaY > SWIPE_THRESHOLD:
        onSwipeDown()

function onWheel(deltaY):
    # 桌面端：向下滚动看下一条，向上滚动看上一条
    if deltaY > 0:
        onSwipeUp()
    else if deltaY < 0:
        onSwipeDown()

function onKeyDown(key):
    # 键盘快捷键：ArrowUp 下一条；ArrowDown 上一条
    if key == 'ArrowUp':
        onSwipeUp()
    else if key == 'ArrowDown':
        onSwipeDown()

# 播放器事件
function onPlayerTimeUpdate(currentTime):
    if activeWorkspace == null: return
    ws = workspaces[activeWorkspace]
    if ws == null or ws.mediaList.length == 0: return
    currentMedia = ws.mediaList[ws.currentIndex]
    currentMedia.playbackPosition = currentTime

function onPlayerMediaEnd():
    if activeWorkspace == null: return
    ws = workspaces[activeWorkspace]
    currentMedia = ws.mediaList[ws.currentIndex]
    currentMedia.playbackPosition = 0

# 显示新媒体（播放器始终用原资源 resourceUrl）：
# 1) mediaToPlay = workspaces[activeWorkspace].mediaList[currentIndex]
# 2) savedPosition = mediaToPlay.playbackPosition or 0
# 3) player.load(mediaToPlay.resourceUrl)
# 4) if savedPosition > 0: player.seek(savedPosition)
# 5) player.play()

# 列表渲染（网格使用缩略图 thumbnailUrl）：
# for item in workspaces[`tag_${tag}`].mediaList:
#   grid.renderThumbnail(item.thumbnailUrl)