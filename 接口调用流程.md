概述
- 本文按“页面/视图 → 触发 → 接口调用 → 响应/后续状态”的顺序，全面梳理调用流程，并以你提出的六类接口为主线。
- 无用户概念；`session` 仅作为随机种子（`session_seed`）。播放器与缩略图网格使用统一的数据源 `GET /media-list`，通过参数区分标签或排序模式。

- 页面与视图
- 首页（播放器视图：`player`）——首屏数据通过 `GET /media-list?seed=<session_seed>&offset=0&limit=PAGE_SIZE&order=seeded` 获取
- 首页缩略图网格（`home_grid`，可选）——同样使用 `GET /media-list?seed=<session_seed>&offset=0&limit=PAGE_SIZE&order=seeded`
- 标签列表页（网格视图：`tag_grid`，如 `like`/`favorite`）——通过 `GET /media-list?tag=<tag>&offset=0&limit=PAGE_SIZE` 获取
- 标签详情播放（仍是播放器视图：在该标签的顺序里播放）

- 冷启动流程（App → 首页）
- 触发：应用首次启动 `onAppColdStart()`
- 调用：`GET /session`（可选传 `seed`，不传则后端生成）
- 响应：`{ session_seed }`
- 后续：进入首页播放器视图，发起首屏数据加载
  - 调用：`GET /media-list?seed=<session_seed>&offset=0&limit=PAGE_SIZE&order=seeded`
  - 响应：`{ items: MediaItem[], offset, hasMore }`
  - 状态：设置 `workspaces['feed']`，`currentIndex = 0`，随后浏览器请求真实资源：`GET /media-resource/{items[0].id}`，播放器加载并播放第一条

首页（推荐流播放器）上下滑播放
- 触发：向上滑 `onSwipeUp()`（下一条）
  - 行为：`currentIndex += 1`；若接近尾部且 `hasMore = true`，预取下一页
  - 调用（预取触发时）：`GET /media-list?seed=<session_seed>&offset=<current_offset>&limit=PAGE_SIZE&order=seeded`
  - 响应：追加到 `mediaList`；保持视图为播放器
  - 资源加载：切换到下一条时，浏览器请求 `GET /media-resource/{items[newIndex].id}` 展示图片/视频
- 触发：向下滑 `onSwipeDown()`（上一条）
  - 行为：`currentIndex -= 1`；不产生接口调用（除非需要补齐历史页，当前不需要）
- 可选：切换排序
  - 调用：`GET /media-list?seed=<session_seed>&offset=...&limit=...&order=recent`
  - 场景：需要最新流而非稳定随机排序时使用

在播放器里打标签（全局标签）
- 触发：点击“喜欢”
  - 调用：`POST /tag`，体 `{ media_id, tag: 'like' }`
  - 响应：`{ success: true }`
- 触发：点击“收藏”
  - 调用：`POST /tag`，体 `{ media_id, tag: 'favorite' }`
  - 响应：`{ success: true }`
- 触发：取消“喜欢”
  - 调用：`DELETE /tag`，体 `{ media_id, tag: 'like' }`
  - 响应：`204 No Content`
- 触发：取消“收藏”
  - 调用：`DELETE /tag`，体 `{ media_id, tag: 'favorite' }`
  - 响应：`204 No Content`
- 可选：查询标签定义列表（用于构建标签页入口）
  - 调用：`GET /tags`
  - 响应：`{ tags: string[] }`（如 `['like','favorite']`）

标签列表页（缩略图网格）
- 触发：从首页或导航切换到标签页 `openTagGrid(tag)`
  - 视图：`currentView = 'tag_grid'`
  - 调用：`GET /media-list?tag=<tag>&offset=0&limit=PAGE_SIZE`
  - 响应：`{ items: MediaItem[], offset, hasMore }`（`items[*].thumbnailUrl` 必填）
  - 资源加载：网格展示时，缩略图 URL 指向 `GET /media/{id}/thumbnail`
- 触发：网格滚动到底部附近（分页加载）
  - 调用：`GET /media-list?tag=<tag>&offset=<current_offset>&limit=PAGE_SIZE`
  - 响应：追加到网格数据源；维持 `tag_grid` 视图
- 触发：点击缩略图进入详情 `onThumbnailClick(tag, index)`
  - 行为：切换至播放器视图并在当前标签列表顺序中播放
  - 调用：无需额外接口（复用已加载的 `items` 和索引）；若接近尾部且 `hasMore`，在播放器中预取：`GET /media-list?tag=<tag>&offset=...&limit=...`

- 标签详情播放（在标签顺序内上下滑）
- 触发：向上滑 `onSwipeUp()` / 向下滑 `onSwipeDown()`
  - 行为：移动 `currentIndex`；接近末尾自动分页加载
  - 调用（需要预取时）：`GET /media-list?tag=<tag>&offset=<current_offset>&limit=PAGE_SIZE`
  - 响应：更新该标签工作区的 `mediaList`
- 触发：返回标签网格 `onBackFromTagDetail(tag)`
  - 行为：调用 `openTagGrid(tag, scrollToIndex=currentIndex)` 保持列表定位
  - 调用：一般不产生网络请求（已在该工作区缓存了数据）；若列表未加载足够数据，滚动过程中可能再次触发分页 `GET /media-list?tag=<tag>`

媒体详情与缩略图（可选）
- 触发：需要单媒体缩略图（如占位/预生成方案）
  - 调用：`GET /media/{id}/thumbnail`
  - 响应：`{ id, thumbnailUrl, width?, height? }` 或图片二进制（按实现）

- 会话重置（重新播种）
- 触发：用户希望刷新推荐流（重新生成随机顺序）
  - 调用：`GET /session` → 获取新的 `session_seed`
  - 后续：清理 `workspaces['feed']`，重新发起 `GET /media-list?seed=<new_seed>&offset=0&limit=PAGE_SIZE&order=seeded`

- -事件到接口映射（速查）
- App 启动 → `GET /session` → `GET /media-list`
- 播放器上滑/靠近末尾 → 预取 `GET /media-list`
- 点赞/收藏/取消 → `POST /tag` / `DELETE /tag`
- 打开标签页 → `GET /media-list?tag=<tag>`（网格缩略图）
- 标签网格滚动 → `GET /media-list?tag=<tag>`（分页追加）
- 缩略图点击 → 切换到播放器（复用列表数据）
- 标签详情上滑/靠近末尾 → 预取 `GET /media-list?tag=<tag>`
- 返回标签页 → 定位到索引（通常不请求）
- 需要缩略图 → `GET /media/{id}/thumbnail`

- -一致性与约束
- `GET /media-list` 返回用于播放器与网格的统一数据源；非标签模式下 `thumbnailUrl` 可能为空，标签模式下必填；
- `session_seed` 仅用于推荐流排序；与用户或登录无关。
- 标签为全局集合；写入/移除接口不包含 `user_id`。
