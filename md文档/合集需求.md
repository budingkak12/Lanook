这是一份基于我们所有讨论更新后的 **v2.0 版本 PRD**。

这份文档重点强化了**“多种方式添加合集”**的逻辑定义，以及**“非托管资源（懒惰自愈）”**的异常处理机制。

---

# 产品需求文档 (PRD) - 局域网沉浸式媒体中心 v2.0

| 项目 | 内容 |
| --- | --- |
| **项目名称** | 局域网沉浸式媒体中心 (LAN-TikTok) |
| **版本号** | v2.0 (Updated: Logic Refinement) |
| **核心理念** | **“丝般顺滑”**的浏览体验 + **“虚实分离”**的资产索引 + **“懒惰自愈”**的健壮性 |
| **技术栈** | Backend: Python FastAPI / DB: PostgreSQL (pgvector) <br>

<br> Client: Android (Native), iOS (Native), Web |

---

## 1. 核心业务逻辑：虚实分离

本系统**绝不**对服务器硬盘上的物理文件进行移动、重命名或复制操作。所有操作仅针对数据库中的“索引（Asset）”和“引用（Reference）”。

* **物理层:** 原始文件存储（如 `D:\Movies`, `E:\Photos`）。
* **逻辑层:** 数据库记录。合集（Collection）仅存储 `Asset ID` 的列表。
* **一致性策略:** 采用“最终一致性”。不实时监听文件变动，在**使用时**或**定时体检时**发现并标记异常。

---

## 2. 功能模块详解

### 2.1 资产索引与入库 (Asset Indexing)

**场景：** 用户通过“资源管理器”视图选择文件夹。

* **功能描述:**
* 支持选择父文件夹，系统递归扫描所有子文件。
* **去重逻辑:** 计算 `QuickHash` (文件大小 + 修改时间 + 前 1KB 数据)。若库中已存在该 Hash，复用旧 ID，不重复创建。
* **初始化状态:** 新入库 Asset 状态为 `normal`，AI 字段为空，进入后台处理队列（生成封面、AI 向量化）。



### 2.2 合集管理 (Collection Management) - **重点逻辑更新**

**场景：** 用户将媒体资源添加到“合集”。

**核心需求：** 支持三种维度的添加操作，后端需提供统一接口处理。

| 添加方式 | 用户操作 | 数据逻辑 (API Payload) | 后端处理逻辑 |
| --- | --- | --- | --- |
| **A. 跨页勾选** | 在列表/搜索结果中手动勾选多个 Item (跨分页) | `asset_ids: [101, 102, 305]` | 直接将 ID 写入关联表。 |
| **B. 目录导入** | 在资源管理器选中文件夹 `D:\Video` | `scan_paths: ["D:\Video"]` | 1. 立即扫描目录入库。<br>

<br>2. 获取/生成对应 IDs。<br>

<br>3. 写入关联表。 |
| **C. 搜索全选** | 搜索“猫”，点击“将所有结果加入合集” | `search_query: "猫"`<br>

<br>`add_all: true` | **Query Replay (重演):**<br>

<br>1. 后端复用搜索逻辑（无分页）。<br>

<br>2. 找出所有匹配 ID。<br>

<br>3. 写入关联表。 |

### 2.3 沉浸式播放 (Immersive Player)

**场景：** 类似抖音的全屏上下滑动。

* **性能指标:**
* **秒开:** 封面图必须先行。视频流加载延迟 < 200ms。
* **预加载:** 播放 N 时，预缓冲 N+1。
* **大文件:** 必须支持 HTTP Range Request (206 Partial Content)，允许随意拖拽进度条。


* **异常处理 (The Lazy Protocol):**
* 若播放时发现物理文件丢失 -> 播放器报错 -> 自动切下一个 -> 后端标记 Asset 为 `missing`。



### 2.4 智能搜索 (AI Search)

* **功能:** 语义搜索（如“海边的日落”）。
* **机制:**
* 后台异步任务调用 CLIP 模型生成向量。
* 搜索时计算 Cosine Similarity。
* 搜索结果可直接触发“C. 搜索全选”添加到合集。



---

## 3. 数据模型设计 (Schema)

```sql
-- 1. 资产表 (Assets) - 物理文件的影子
CREATE TABLE assets (
    id SERIAL PRIMARY KEY,
    file_path TEXT NOT NULL,          -- 绝对路径 (D:/Videos/a.mp4)
    file_hash VARCHAR(64) INDEX,      -- 快速指纹，用于识别改名/移动
    media_type VARCHAR(10),           -- video/image
    duration INT,                     -- 视频时长(秒)
    
    -- 状态机
    status VARCHAR(20) DEFAULT 'normal', -- normal (正常), missing (文件丢失)
    
    -- AI 数据
    vector_embedding VECTOR(512),     -- CLIP 向量
    created_at TIMESTAMP DEFAULT NOW()
);

-- 2. 合集表 (Collections)
CREATE TABLE collections (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100),
    description TEXT
);

-- 3. 关联表 (Collection_Items) - 核心逻辑
CREATE TABLE collection_items (
    collection_id INT REFERENCES collections(id),
    asset_id INT REFERENCES assets(id),
    added_at TIMESTAMP DEFAULT NOW(),
    PRIMARY KEY (collection_id, asset_id) 
);

```

---

## 4. 关键 API 接口定义

### 4.1 通用添加接口 (Smart Add)

**路径:** `POST /api/collections/{id}/items`

**请求体 (JSON Request Body):**

```json
{
  // 模式 1: 明确指定 ID (对应方式 A)
  "asset_ids": [1001, 1002, 1005],

  // 模式 2: 指定物理路径 (对应方式 B)
  "scan_paths": ["D:/Photos/2023_Trip"],
  "recursive": true,

  // 模式 3: 指定查询条件 (对应方式 C - Query Replay)
  "from_search_result": true,
  "search_query": "开心的狗",
  "search_filters": {
      "type": "video",
      "min_duration": 10
  }
}

```

*注意：这三个参数组是互斥或组合关系，后端需按优先级处理。*

### 4.2 流媒体播放接口

**路径:** `GET /static/stream/{asset_id}`

**逻辑:**

1. `SELECT file_path FROM assets WHERE id = {asset_id}`
2. `if not os.path.exists(file_path)`:
* `UPDATE assets SET status = 'missing' WHERE id = {asset_id}`
* Return 404


3. `else`:
* Return `StreamingResponse` (Status 206)



### 4.3 手动体检接口

**路径:** `POST /api/maintenance/sync`
**逻辑:** 遍历 DB 中所有 `normal` 资产，批量检测文件存在性，修正状态。

---

## 5. 异常处理规范 (Robustness)

| 异常情况 | 检测时机 | 系统行为 | 用户感知 |
| --- | --- | --- | --- |
| **文件被外部删除** | 用户点击播放时 | API返404 -> 标记DB `missing` | 播放失败/自动跳过，该项稍后从列表消失 |
| **文件被移动/改名** | 重新扫描目录时 | 计算Hash -> 匹配旧记录 -> 更新路径 | 无感知，数据自动迁移 |
| **硬盘未挂载** | 任何IO操作时 | 系统捕获 `OSError` | 提示“存储设备离线”，**不**标记为丢失(防止误删) |
| **不支持的格式** | 扫描入库时 | FFMpeg 解析失败 | 忽略该文件，不入库 |

---

## 6. 开发路线图 (Roadmap)

### Phase 1: 基础骨架 (The Skeleton)

* **目标:** 本地跑通，能播放。
* **任务:**
1. 搭建 FastAPI + StaticFiles 挂载。
2. 实现“目录扫描”接口，将文件存入 DB。
3. Android 端实现 ViewPager2 + ExoPlayer。
4. **验证点:** 手机能连上电脑 IP，刷出电脑里的视频，拖拽不卡。



### Phase 2: 逻辑完善 (The Brain)

* **目标:** 像个真正的 App，支持管理。
* **任务:**
1. 实现“合集”增删改查。
2. 实现 API 4.1 (Smart Add)，打通三种添加方式。
3. 实现“懒惰自愈”逻辑（播放失败自动标记）。
4. **验证点:** 拔掉U盘后，APP 不会崩溃，只是提示资源失效。



### Phase 3: AI 增强 (The Soul)

* **目标:** 智能化搜索。
* **任务:**
1. 集成 `sentence-transformers` (CLIP)。
2. 后台任务队列生成向量。
3. 实现语义搜索接口。