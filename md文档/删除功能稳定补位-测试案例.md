# 删除功能（稳定补位）端到端测试案例

目标：验证“列表多选删除、详情单删、顺序稳定就地补位、列表与详情数据同步一致”。

— 前置条件 —
- 排序键稳定：后端/本地按 `created_at DESC, id DESC` 或等价不可变主键序。
- 网格为 3 列（示例编号 1-9 为首屏顺序：1 2 3 / 4 5 6 / 7 8 9）。
- 已接入接口：`DELETE /media/{id}` 与 `POST /media/batch-delete {ids}`；404/410 视作已删除。
- 列表与详情订阅同一 Repository 流，支持删除事件驱动的差量更新与锚点恢复。

— 数据准备 —
- 准备 ≥12 个媒体样本（命名含可见序号），确保排序可预测：1..12。
- 清空缩略图缓存后首次进入列表，确保可重现回填/补位行为。

=========================== 列表（多选删除） ===========================

TC-GRID-01 删除中间段 4-6，7-9 就地上移补位
- 前置：首屏显示 1..9，滚动位置在首屏顶部。
- 步骤：多选 4、5、6 → 确认删除。
- 期望：
  - UI 仅差量移除 4/5/6，无整表刷新；无灰底占位与闪烁。
  - 原 7/8/9 上移填补空位，视觉顺序变为 1 2 3 / 7 8 9 /（若有 10..12）继续回填。
  - `firstVisibleItemIndex` 与 `offset` 变化在可接受范围（offset 漂移 ≤20px）。
  - 列表计数与分页总数同步更新；选中态清空；一次性成功提示。

TC-GRID-02 跨页多选删除与回填
- 前置：每页 30 项；选择当前页末尾的 28、29、30 与下一页的 31、32。
- 步骤：批量删除 → 等待回包。
- 期望：
  - 28..32 从可见/后续列表差量移除；分页游标不重置；滚动锚点保持。
  - 当前页不足位，用后续页（33..）回填至满格；顺序稳定不重排。

TC-GRID-03 搜索/筛选视图下稳定补位
- 前置：启用关键字或标签筛选（使结果为子集且有 1..9 的子序列）。
- 步骤：删除可见子序列中的 2、3 → 观察补位。
- 期望：按筛选结果内的稳定序补位；主列表与该筛选视图计数同时更新。

TC-GRID-04 部分失败回包处理
- 前置：选择 5 个 ID，其中 2 个构造为服务端失败（如权限/磁盘错误）。
- 步骤：批量删除 → 接收 `{deleted:[3], failed:[2]}`。
- 期望：
  - 仅移除成功的 3 个；失败 2 个仍在列表并保持选中态；结果弹窗列出失败数量与原因。
  - 可直接点击“重试删除失败项”。

TC-GRID-05 幂等：已在他端删除（404/410）
- 前置：选中 2 个已在他端删除的 ID + 1 个正常 ID。
- 步骤：批量删除。
- 期望：
  - 404/410 视为成功，本地清理对应项；3 项均从列表消失；无重复错误提示；顺序稳定。

TC-GRID-06 删除导致当前页空 → 回退上一页
- 前置：滚动至页面末尾，选中该页所有可见项。
- 步骤：删除。
- 期望：
  - 当前页清空后自动回退上一页顶部或保持上一个锚点；显示仍稳定；空状态页不闪现。

TC-GRID-07 快速连续两次批量删除
- 前置：首屏；快速执行“删除 4-6”后紧接“删除 7-9”。
- 步骤：两次确认间隔 < 1s。
- 期望：
  - 第二次操作在首批回包后串行执行；无重复 Toast；锚点恢复正确；结果顺序稳定。

=========================== 详情（单个删除） ===========================

TC-DETAIL-01 单删后跳到相邻项
- 前置：从列表进入详情，当前为 5，邻居为 6（按稳定序）。
- 步骤：点击删除 → 等待成功。
- 期望：
  - 自动导航到 6；返回列表时不出现 5；列表补位后顺序稳定。

TC-DETAIL-02 删除最后一项 → 返回列表
- 前置：打开详情的当前为该筛选结果的最后一项。
- 步骤：删除。
- 期望：
  - 自动返回列表；该 ID 不可再进入详情；列表计数-1，无重排。

TC-DETAIL-03 搜索来源的详情单删
- 前置：从搜索结果进入详情（子集顺序）。
- 步骤：删除当前项。
- 期望：
  - 搜索结果与主列表同时清除该项；若无相邻项则返回；两个视图数据一致。

TC-DETAIL-04 播放中的视频删除
- 前置：详情播放视频项。
- 步骤：点击删除。
- 期望：
  - 播放立即停止并提示“已删除”；磁盘/缩略图不可再次命中；返回列表后无该项。

=========================== 同步与一致性/异常 ===========================

TC-SYNC-01 列表与详情共享删除事件
- 前置：列表与详情同时驻留（分屏或快速切换）。
- 步骤：在详情删除 5。
- 期望：
  - 列表收到删除事件后差量移除 5，补位稳定；反之在列表删除也能导致打开中的详情自动退出/跳转。

TC-SYNC-02 并发他端删除
- 前置：A 设备打开详情 5，B 设备删除 5。
- 步骤：A 设备对 5 执行删除。
- 期望：
  - 服务端返回 404/410；A 仍视作成功并本地清理；UI 不出现错误对话，仅展示“已删除”。

TC-SYNC-03 离线与按钮禁用
- 前置：断网；进入列表与详情。
- 步骤：尝试删除。
- 期望：
  - 删除入口置灰或弹出离线说明；不修改本地可见列表；恢复网络后行为正常。

TC-SYNC-04 缓存/缩略图清理
- 前置：确认被删项的缩略图与内存缓存命中。
- 步骤：删除这些项。
- 期望：
  - 缩略图文件与内存缓存条目被清理；重新进入列表不再展示旧缩略图；无“空白图”残留。

TC-SYNC-05 计数与相册聚合
- 前置：某相册/标签页中删除 3 项。
- 步骤：删除。
- 期望：
  - 相册/标签计数减少 3；全局总数一致；跨视图保持一致。

=========================== 可测性与度量 ===========================

- 锚点稳定度：记录 `firstVisibleItemIndex/offset`，删除前后偏差 ≤20px。
- 动画与帧率：批量删除 50/100/200 项时掉帧不超过阈值（如 16ms*3 以内）。
- 接口正确性：批删回包的 `deleted/failed` 与 UI 变更一一对应，无多删/漏删。

