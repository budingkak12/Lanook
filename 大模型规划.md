落地计划（分步可测，允许重建 DB）

  1. 基础准备

  - 清空/重建数据库：uv run python -m scripts.init_db --media-path 测试图片（确保 media 入库）。
  - 安装依赖已就绪（含 insightface/hdbscan）。

  2. 人脸聚类 V3 验证（已上线，可复测）

  - 命令：uv run python -m scripts.rebuild_faces --base 测试图片 --threshold 0.65
  - 验证：GET /face-clusters、GET /face-clusters/{id}；前端查看 http://localhost:3000/face-test。

3. CLIP/SigLIP 向量检索（已完成 2025-11-18）

  - 目标：文本搜图 / 图搜图。
  - 交付：
      - 新表 clip_embeddings + Faiss 索引用例：faiss_vectors/sentence-transformers_siglip-base-patch16-224.faiss。
      - 服务：clip_service（SentenceTransformer SigLIP/CLIP，支持重建、Faiss 搜索、图搜图补向量）。
      - API：
          - POST /search/clip {query_text?, image_id?, top_k, model} → 返回 media list + score。
          - POST /clip/rebuild {base_path?, model, media_ids?, batch_size, limit}。
      - 脚本：uv run python -m scripts.clip_rebuild --base 测试图片 --model siglip。
      - 前端：/smart-search 测试页（文本或图片 ID 触发搜索，展示得分）。
  - 验证：
      - 重建向量：uv run python -m scripts.clip_rebuild --base 测试图片 --model siglip
      - 接口自测：curl -X POST http://localhost:8000/search/clip -H "Content-Type: application/json" -d '{"query_text":"夕阳 海边"}'。

  4. 标签补充（wd-vit-tagger-v3 白名单版）

  - 目标：细粒度标签 + 兼容真实照片。
  - 开发内容：WdTagService（过滤白名单标签），表 media_tags 可复用，新增 source_model/confidence。
  - API：POST /tags/rebuild，GET /media/{id}/tags。
  - 测试：脚本 scripts/wd_tag_rebuild.py；前端在 /smart-search 增加标签筛选。

  5. NSFW 双路融合

  - 目标：CLIP zero-shot 判级 + WD 细标签。
  - 开发内容：media_nsfw 表，字段 level(0-3)、tags、model；POST /nsfw/rebuild。
  - 搜索参数：nsfw_mode=allow|blur|block。
  - 测试：跑重建，前端/接口过滤验证。

  6. OCR 层

  - 目标：OCR 文本入 FTS5，支持“文搜图”。
  - 开发内容：PaddleOCR CPU；表 media_ocr（text, confidence）。
  - API：POST /ocr/rebuild；搜索时 BM25 融合。
  - 测试：含文字图片检索示例。

  7. 搜索融合与前端完善

  - 统一 /search：接收 text/tag/face_cluster/ocr/nsfw/filter，排序 = clip_score + bm25β + tag_weightγ。
  - 前端 /smart-search 汇总控件：文本框、标签筛选、人脸聚类下拉、NSFW 开关。

  8. EXIF/GPS（可选后续）

  - 解析 EXIF、写入表/索引，支持地理过滤；测试用带 GPS 的样例。

  每一步交付物：脚本 + API + 前端入口（如适用），均可在本地跑完后手动验证。你确认步骤 3 先做，我就按此路线开工。
